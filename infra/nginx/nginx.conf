worker_processes 1;

events {
    worker_connections 1024;
}

http {
    resolver 127.0.0.11 valid=30s;
   
    include       mime.types;
    default_type  application/octet-stream;

    server {
        listen 80;

        location /rate-limit {
            content_by_lua_block {
                -- user_id 추출, 프록시에서 헤더 직접 사용은 보안 상 취약할 가능성
                local headers = ngx.req.get_headers()
                local user_id = headers["user-id"]
                if not user_id then
                    ngx.say("missing user-id header")
                    return ngx.exit(400)
                end
                
                local redis = require "resty.redis"
                
                -- 현재 Sentinel은 Redis와 동일 컨테이너
                local sentinels = {
                    { host = "redis-master", port = 26379 },
                    { host = "redis-replica1", port = 26379 },
                    { host = "redis-replica2", port = 26379 },
                }
                local master_name = "mymaster"  -- sentinel.conf에서 정의한 master 이름
                
                -- Sentinel에서 마스터 주소 가져오기
                local function get_master()
                    for _, s in ipairs(sentinels) do
                        local red = redis:new()
                        red:set_timeout(1000)  -- 1초 타임아웃
                        local ok, err = red:connect(s.host, s.port)
                        if not ok then
                            ngx.log(ngx.ERR, "failed to connect to sentinel ", s.host, ":", s.port, " - ", err)
                        else
                            local res, err = red:sentinel("get-master-addr-by-name", master_name)
                            if res and #res == 2 then
                                -- res[1] = IP, res[2] = port
                                return res[1], tonumber(res[2])
                            end
                        end
                    end
                    return nil, nil
                end

                -- 마스터 조회
                local master_ip, master_port = get_master()
                if not master_ip then
                    ngx.say("failed to get master from sentinels")
                    return ngx.exit(500)
                end

                -- 마스터에 연결
                local function connect_master(retries)
                    retries = retries or 3
                    local last_err
                    for i = 1, retries do
                        local master_ip, master_port = get_master()  -- Sentinel 조회
                        if master_ip then
                            local red = redis:new()
                            red:set_timeout(1000)
                            local ok, err = red:connect(master_ip, master_port)
                            if ok then
                                return red
                            else
                                last_err = err
                                ngx.log(ngx.WARN, "failed to connect master, retrying: ", err)
                                ngx.sleep(0.1)
                            end
                        else
                            last_err = "cannot get master from sentinels"
                            ngx.sleep(0.1)
                        end
                    end
                    return nil, last_err
                end
                
                local red = connect_master()

                -- 등록한 Redis Function 호출
                local res, err = red:fcall("check_if_allowed", 0, user_id)
                if not res then
                    ngx.say("failed to call redis function: ", err)
                    return ngx.exit(500)
                end
                
                -- 결과에 따른 반환
                if res == 0 then return ngx.exit(429) end
            }
        }
    }
}
